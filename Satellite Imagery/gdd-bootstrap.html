<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>G.R.O.W Growing Degree Days</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
  <style>
    :root { --app-green: #8cb43a; --app-green-dark: #739431; }
    body { background-color: #f4f7f6; }
    .card { border: none; }
    .highlight { color: var(--app-green) !important; }
    .btn-main-green { background-color: var(--app-green) !important; border-color: var(--app-green) !important; color: #fff !important; }
    .btn-main-green:hover { background-color: var(--app-green-dark) !important; }
    .expand-icon.collapsed { transform: rotate(-90deg); }
    .expand-icon { transition: transform 0.2s ease-in-out; }
    .material-icons { vertical-align: middle; }
    .form-control:focus, .form-select:focus { border-color: var(--app-green); box-shadow: 0 0 0 0.2rem rgba(140, 180, 58, 0.25); }
  </style>
</head>
<body>
  <div class="container py-4">

    <div class="mb-3 p-4 bg-white rounded-3 shadow-sm">
      <h2 class="mb-1 fw-bold">Growing Degree Days (GDD)</h2>
      <p class="text-muted mb-0">Anticipate pest development and optimize management decisions.</p>
    </div>

    <div class="mb-4 bg-white p-4 rounded-3 shadow-sm">
        <div class="row">
          <div class="col-md-4">
            <label for="pestSelect" class="form-label fw-bold">1. Select Pest/Disease Model:</label>
            <select id="pestSelect" class="form-select">
              <option value="ascospore">Apple Scab (Ascospore)</option>
              <option value="other">Generic Pest (Base 10Â°C)</option>
            </select>
          </div>
          <div class="col-md-4">
            <label for="biofixFrom" class="form-label fw-bold">2. Set Biofix Date:</label>
            <input type="date" id="biofixFrom" class="form-control">
          </div>
           <div class="col-md-4 d-flex align-items-end">
             <button id="runAnalysisBtn" class="btn btn-main-green w-100">Run GDD Analysis</button>
           </div>
        </div>
    </div>

    <div id="appleScabInfoCard" class="alert alert-info" style="display:none;">
      <strong>Apple Scab Model:</strong> For best results, set the biofix date to when buds begin to break.
    </div>
    
    <div id="results-container" class="d-none">
        <div class="row">
          <div class="col-lg-4 mb-4">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <h5 class="card-title text-muted">Current Stage</h5>
                <p class="fs-4 fw-bold highlight" id="growthStageTitle">Loading...</p>
                <hr/>
                <div><strong>Accumulated GDD:</strong> <span id="accumulatedGddValue">...</span></div>
                <div><strong>Today's GDD:</strong> <span id="todaysGddValue">...</span></div>
                <div class="text-muted small mt-2">Next Stage: <span id="growthStageRange">...</span></div>
              </div>
            </div>
          </div>
          <div class="col-lg-8 mb-4">
            <div class="card shadow-sm h-100">
              <div class="card-body">
                <h5 class="card-title text-muted">GDD Accumulation Chart</h5>
                <canvas id="gddChart"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div class="card shadow-sm">
           <div class="card-header">
                <h5 class="mb-0">All Growth Stages</h5>
           </div>
           <div class="card-body p-0" id="allGrowthStages">
                <!-- Stages will be inserted here -->
           </div>
        </div>
    </div>
    
    <div id="loading-indicator" class="text-center p-5 d-none">
        <div class="spinner-border highlight" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 text-muted">Fetching weather data and calculating GDD...</p>
    </div>

  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation/dist/chartjs-plugin-annotation.min.js"></script>

  <script>
    document.addEventListener('DOMContentLoaded', function() {
      const PROXY_URL = 'http://localhost:3001';
      const PEST_MODELS = {
        ascospore: { name: "Apple Scab", baseTemp: 0, stages: [ { gdd: 55, name: "2% Ascospore Maturation" }, { gdd: 108, name: "7% Ascospore Maturation" }, { gdd: 161, name: "23% Ascospore Maturation" }, { gdd: 242, name: "50% Ascospore Maturation" }, { gdd: 331, name: "82% Ascospore Maturation" }, { gdd: 418, name: "98% Ascospore Maturation" }, { gdd: 472, name: "100% Ascospore Maturation" } ] },
        other: { name: "Generic Pest", baseTemp: 10, stages: [ { gdd: 100, name: "Egg Hatch" }, { gdd: 250, name: "First Instar" }, { gdd: 450, name: "Second Instar" }, { gdd: 700, name: "Adult Emergence" } ] }
      };
      let gddChart = null;

      const biofixDateEl = document.getElementById('biofixFrom');
      const pestSelectEl = document.getElementById('pestSelect');
      const runAnalysisBtn = document.getElementById('runAnalysisBtn');
      const appleScabInfoCardEl = document.getElementById('appleScabInfoCard');
      const resultsContainer = document.getElementById('results-container');
      const loadingIndicator = document.getElementById('loading-indicator');
      
      const todaysGddValueEl = document.getElementById('todaysGddValue');
      const accumulatedGddValueEl = document.getElementById('accumulatedGddValue');
      const growthStageTitleEl = document.getElementById('growthStageTitle');
      const growthStageRangeEl = document.getElementById('growthStageRange');
      const allGrowthStagesContainer = document.getElementById('allGrowthStages');
      const gddChartEl = document.getElementById('gddChart').getContext('2d');

      async function runAnalysis() {
        const biofixDate = biofixDateEl.value;
        const pestKey = pestSelectEl.value;
        const pestModel = PEST_MODELS[pestKey];

        if (!biofixDate) { alert("Please set a Biofix Date."); return; }
        
        const startDate = new Date(biofixDate);
        const endDate = new Date();
        if (startDate > endDate) { alert("Biofix date cannot be in the future."); return; }
        
        loadingIndicator.classList.remove('d-none');
        resultsContainer.classList.add('d-none');
        runAnalysisBtn.disabled = true;

        try {
          const response = await fetch(`${PROXY_URL}/fetch-historical-weather`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
              date_start: startDate.toISOString().split('T')[0],
              date_end: endDate.toISOString().split('T')[0]
            })
          });
          const result = await response.json();
          if (!response.ok || !result.success) throw new Error(result.details || 'API request failed');
          
          calculateAndDisplayGdd(result.data, pestModel);
          resultsContainer.classList.remove('d-none');

        } catch (error) {
          console.error("Error during analysis:", error);
          alert(`Failed to run analysis: ${error.message}`);
        } finally {
            loadingIndicator.classList.add('d-none');
            runAnalysisBtn.disabled = false;
        }
      }

      function calculateAndDisplayGdd(weatherData, pestModel) {
        let accumulatedGdd = 0;
        const chartData = [];

        weatherData.forEach(day => {
          const avgTemp = (day.temperature_max + day.temperature_min) / 2;
          let dailyGdd = avgTemp - pestModel.baseTemp;
          dailyGdd = Math.max(0, dailyGdd);
          accumulatedGdd += dailyGdd;
          chartData.push({ x: new Date(day.date), y: accumulatedGdd });
        });

        const todaysGdd = chartData.length > 0 ? (chartData[chartData.length - 1].y - (chartData.length > 1 ? chartData[chartData.length - 2].y : 0)) : 0;
        updateUi(pestModel, accumulatedGdd, todaysGdd, chartData);
      }

      function updateUi(pestModel, accumulatedGdd, todaysGdd, chartData) {
        let currentStage = { name: "Biofix Period" };
        let nextStage = pestModel.stages[0];
        for(let i = 0; i < pestModel.stages.length; i++) {
            if (pestModel.stages[i].gdd <= accumulatedGdd) {
                currentStage = pestModel.stages[i];
                nextStage = (i < pestModel.stages.length - 1) ? pestModel.stages[i+1] : { gdd: 'N/A', name: 'Final stage reached' };
            } else {
                nextStage = pestModel.stages[i];
                break;
            }
        }
        
        todaysGddValueEl.textContent = todaysGdd.toFixed(1);
        accumulatedGddValueEl.textContent = accumulatedGdd.toFixed(1);
        growthStageTitleEl.textContent = currentStage.name;
        growthStageRangeEl.textContent = `${nextStage.name} at ${nextStage.gdd} GDD`;

        allGrowthStagesContainer.innerHTML = pestModel.stages.map(stage => `
            <div class="d-flex justify-content-between p-3 border-bottom ${accumulatedGdd >= stage.gdd ? 'bg-light fw-bold highlight' : ''}">
                <span>${stage.name}</span>
                <span class="badge bg-secondary">${stage.gdd} GDD</span>
            </div>`).join('');
        
        renderChart(chartData, pestModel);
      }
      
      function renderChart(chartData, pestModel) {
        if (gddChart) gddChart.destroy();
        
        const annotations = pestModel.stages.map(stage => ({
            type: 'line',
            yMin: stage.gdd,
            yMax: stage.gdd,
            borderColor: 'rgba(0, 0, 0, 0.2)',
            borderWidth: 1,
            borderDash: [5, 5],
            label: { content: stage.name, enabled: true, position: 'end', backgroundColor: 'rgba(245,245,245,0.8)', color: '#333', font: {size: 10} }
        }));

        gddChart = new Chart(gddChartEl, {
            type: 'line',
            data: { datasets: [{ label: 'Accumulated GDD', data: chartData, borderColor: 'var(--app-green)', backgroundColor: 'rgba(140, 180, 58, 0.1)', fill: true, tension: 0.1 }] },
            options: {
                responsive: true,
                scales: {
                    x: { type: 'time', time: { unit: 'day' }, title: { text: 'Date', display: true } },
                    y: { beginAtZero: true, title: { text: 'Accumulated GDD', display: true } }
                },
                plugins: { tooltip: { mode: 'index', intersect: false }, annotation: { annotations: annotations } }
            }
        });
      }
      
      pestSelectEl.addEventListener('change', () => {
        appleScabInfoCardEl.style.display = pestSelectEl.value === 'ascospore' ? 'block' : 'none';
      });
      runAnalysisBtn.addEventListener('click', runAnalysis);
      
      const oneMonthAgo = new Date(new Date().setMonth(new Date().getMonth() - 1));
      biofixDateEl.value = oneMonthAgo.toISOString().split('T')[0];
      pestSelectEl.dispatchEvent(new Event('change'));
    });
  </script>
</body>
</html> 